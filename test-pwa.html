<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test PWA CleanMaster</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; line-height: 1.6; }
        .status { padding: 15px; margin: 10px 0; border-radius: 5px; font-weight: bold; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #cce7ff; color: #004085; border: 1px solid #b3d7ff; }
        button { background: #7c3aed; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; margin: 5px; font-size: 16px; }
        button:hover { background: #6d28d9; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 4px; overflow-x: auto; }
        .icon-test { width: 50px; height: 50px; margin: 10px; border: 1px solid #ddd; }
    </style>
</head>
<body>
    <h1>üß™ Test PWA CleanMaster</h1>
    <p>Cette page vous aide √† v√©rifier que votre PWA fonctionne correctement sur iPhone.</p>

    <div class="test-section">
        <h2>üì± Compatibilit√© Navigateur</h2>
        <div id="browserCheck"></div>
    </div>

    <div class="test-section">
        <h2>üîß Service Worker</h2>
        <div id="swStatus"></div>
        <button onclick="testServiceWorker()">Tester Service Worker</button>
        <button onclick="unregisterSW()">D√©sinstaller SW</button>
    </div>

    <div class="test-section">
        <h2>üìÑ Manifest</h2>
        <div id="manifestStatus"></div>
        <button onclick="testManifest()">Tester Manifest</button>
    </div>

    <div class="test-section">
        <h2>üíæ Installation PWA</h2>
        <div id="installStatus"></div>
        <button id="installBtn" onclick="installPWA()" style="display:none;">Installer l'App</button>
    </div>

    <div class="test-section">
        <h2>üñºÔ∏è Ic√¥nes</h2>
        <div id="iconTest"></div>
        <button onclick="testIcons()">Tester Ic√¥nes</button>
    </div>

    <div class="test-section">
        <h2>üíæ Cache/Stockage</h2>
        <div id="storageStatus"></div>
        <button onclick="testStorage()">Tester Stockage</button>
        <button onclick="clearStorage()">Vider Cache</button>
    </div>

    <div class="test-section">
        <h2>üìä Informations Syst√®me</h2>
        <div id="systemInfo"></div>
        <button onclick="getSystemInfo()">Afficher Infos</button>
    </div>

    <div class="test-section">
        <h2>üöÄ Actions Rapides</h2>
        <button onclick="window.location.href='index.html'">üè† Aller √† CleanMaster</button>
        <button onclick="window.location.reload()">üîÑ Recharger</button>
        <button onclick="openDevTools()">üîß Console D√©veloppeur</button>
    </div>

    <script>
        let deferredPrompt;

        // Test de compatibilit√© navigateur
        function checkBrowser() {
            const checks = {
                'Service Workers': 'serviceWorker' in navigator,
                'Fetch API': 'fetch' in window,
                'Cache API': 'caches' in window,
                'Notifications': 'Notification' in window,
                'localStorage': 'localStorage' in window,
                'IndexedDB': 'indexedDB' in window
            };

            let html = '';
            let allSupported = true;

            for (const [feature, supported] of Object.entries(checks)) {
                const status = supported ? 'success' : 'error';
                const icon = supported ? '‚úÖ' : '‚ùå';
                html += `<div class="${status}">${icon} ${feature}: ${supported ? 'Support√©' : 'Non support√©'}</div>`;
                if (!supported) allSupported = false;
            }

            const overall = allSupported ? 
                '<div class="success">üéâ Votre navigateur supporte toutes les fonctionnalit√©s PWA!</div>' :
                '<div class="warning">‚ö†Ô∏è Certaines fonctionnalit√©s ne sont pas support√©es.</div>';

            document.getElementById('browserCheck').innerHTML = overall + html;
        }

        // Test Service Worker
        async function testServiceWorker() {
            const statusDiv = document.getElementById('swStatus');
            
            if (!('serviceWorker' in navigator)) {
                statusDiv.innerHTML = '<div class="error">‚ùå Service Workers non support√©s</div>';
                return;
            }

            try {
                const registration = await navigator.serviceWorker.register('/sw.js');
                statusDiv.innerHTML = `
                    <div class="success">‚úÖ Service Worker enregistr√© avec succ√®s</div>
                    <div class="info">Scope: ${registration.scope}</div>
                    <div class="info">√âtat: ${registration.active ? 'Actif' : 'En attente'}</div>
                `;
            } catch (error) {
                statusDiv.innerHTML = `<div class="error">‚ùå Erreur: ${error.message}</div>`;
            }
        }

        // Test Manifest
        async function testManifest() {
            const statusDiv = document.getElementById('manifestStatus');
            
            try {
                const response = await fetch('/manifest.json');
                if (response.ok) {
                    const manifest = await response.json();
                    statusDiv.innerHTML = `
                        <div class="success">‚úÖ Manifest charg√© avec succ√®s</div>
                        <div class="info">Nom: ${manifest.name}</div>
                        <div class="info">Nom court: ${manifest.short_name}</div>
                        <div class="info">Ic√¥nes: ${manifest.icons.length} disponibles</div>
                        <div class="info">Mode d'affichage: ${manifest.display}</div>
                    `;
                } else {
                    statusDiv.innerHTML = '<div class="error">‚ùå Impossible de charger le manifest</div>';
                }
            } catch (error) {
                statusDiv.innerHTML = `<div class="error">‚ùå Erreur: ${error.message}</div>`;
            }
        }

        // Test des ic√¥nes
        async function testIcons() {
            const iconDiv = document.getElementById('iconTest');
            const manifest = await fetch('/manifest.json').then(r => r.json());
            
            let html = '<div class="info">Test de chargement des ic√¥nes:</div>';
            
            for (const icon of manifest.icons.slice(0, 4)) { // Tester les 4 premi√®res
                html += `<img src="${icon.src}" class="icon-test" alt="Icon ${icon.sizes}" 
                         onload="this.style.border='2px solid green'" 
                         onerror="this.style.border='2px solid red'">`;
            }
            
            iconDiv.innerHTML = html;
        }

        // Test stockage
        function testStorage() {
            const statusDiv = document.getElementById('storageStatus');
            
            try {
                // Test localStorage
                localStorage.setItem('pwa-test', 'OK');
                const localTest = localStorage.getItem('pwa-test') === 'OK';
                
                // Test sessionStorage
                sessionStorage.setItem('pwa-test', 'OK');
                const sessionTest = sessionStorage.getItem('pwa-test') === 'OK';
                
                statusDiv.innerHTML = `
                    <div class="${localTest ? 'success' : 'error'}">
                        ${localTest ? '‚úÖ' : '‚ùå'} localStorage: ${localTest ? 'Fonctionne' : 'Erreur'}
                    </div>
                    <div class="${sessionTest ? 'success' : 'error'}">
                        ${sessionTest ? '‚úÖ' : '‚ùå'} sessionStorage: ${sessionTest ? 'Fonctionne' : 'Erreur'}
                    </div>
                `;
                
                // Nettoyer
                localStorage.removeItem('pwa-test');
                sessionStorage.removeItem('pwa-test');
                
            } catch (error) {
                statusDiv.innerHTML = `<div class="error">‚ùå Erreur: ${error.message}</div>`;
            }
        }

        // Informations syst√®me
        function getSystemInfo() {
            const infoDiv = document.getElementById('systemInfo');
            
            const info = {
                'User Agent': navigator.userAgent,
                'Plateforme': navigator.platform,
                'Langue': navigator.language,
                'En ligne': navigator.onLine ? 'Oui' : 'Non',
                'Cookles activ√©s': navigator.cookieEnabled ? 'Oui' : 'Non',
                'URL actuelle': window.location.href,
                'Protocol': window.location.protocol,
                'Mode standalone': window.matchMedia('(display-mode: standalone)').matches ? 'Oui' : 'Non'
            };
            
            let html = '';
            for (const [key, value] of Object.entries(info)) {
                html += `<div><strong>${key}:</strong> ${value}</div>`;
            }
            
            infoDiv.innerHTML = html;
        }

        // Installation PWA
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('installBtn').style.display = 'inline-block';
            document.getElementById('installStatus').innerHTML = 
                '<div class="success">üéâ Installation PWA disponible!</div>';
        });

        async function installPWA() {
            if (!deferredPrompt) {
                document.getElementById('installStatus').innerHTML = 
                    '<div class="warning">‚ö†Ô∏è Installation non disponible. Utilisez Safari > Partager > Ajouter √† l\'√©cran d\'accueil</div>';
                return;
            }

            const result = await deferredPrompt.prompt();
            document.getElementById('installStatus').innerHTML = 
                `<div class="${result.outcome === 'accepted' ? 'success' : 'info'}">
                    ${result.outcome === 'accepted' ? '‚úÖ App install√©e!' : '‚ÑπÔ∏è Installation annul√©e'}
                </div>`;
            
            deferredPrompt = null;
            document.getElementById('installBtn').style.display = 'none';
        }

        // Utilitaires
        async function unregisterSW() {
            const registrations = await navigator.serviceWorker.getRegistrations();
            for (const registration of registrations) {
                await registration.unregister();
            }
            document.getElementById('swStatus').innerHTML = 
                '<div class="info">üóëÔ∏è Service Workers d√©sinstall√©s</div>';
        }

        function clearStorage() {
            localStorage.clear();
            sessionStorage.clear();
            if ('caches' in window) {
                caches.keys().then(names => names.forEach(name => caches.delete(name)));
            }
            document.getElementById('storageStatus').innerHTML = 
                '<div class="info">üóëÔ∏è Cache et stockage vid√©s</div>';
        }

        function openDevTools() {
            alert('Pour ouvrir la console d√©veloppeur:\n\n‚Ä¢ Safari iPhone: R√©glages > Safari > Avanc√© > Inspecteur Web\n‚Ä¢ Safari Mac: D√©veloppement > Connecter [iPhone]\n‚Ä¢ Chrome: F12 ou Cmd+Option+I');
        }

        // Initialisation
        window.addEventListener('load', () => {
            checkBrowser();
            
            // V√©rifier si d√©j√† en mode standalone
            if (window.matchMedia('(display-mode: standalone)').matches) {
                document.getElementById('installStatus').innerHTML = 
                    '<div class="success">üéâ App d√©j√† install√©e et lanc√©e en mode standalone!</div>';
            }
        });
    </script>
</body>
</html> 